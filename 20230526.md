# 5월 26일

## ros 설치
- [wiki.ros.org](http://wiki.ros.org/ROS/Installation)로 이동후 noetic 버전 설치
  > - ![Screenshot from 2023-05-26 13-17-33](https://github.com/ajhwan/OpenCV_study/assets/129160008/6e648d99-7909-4c7f-b738-ce211be13d83)
- 터미널 창에서 수행
> 1. sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
> 2. sudo apt install curl # if you haven't already installed curl
> 3. curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
> 4. sudo apt update
> 5. sudo apt install ros-noetic-desktop-full
> 6. source /opt/ros/noetic/setup.bash
> 7. echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
> 8. sudo apt install python3-rosdep python3-rosinstall python3-rosinstall-generator python3-wstool build-essential
> 9. sudo rosdep init
> 10. rosdep update
-------------------------------------------------------------------------------------------------------------
> 1. mkdir -p catkin_ws/src 
  > - 디렉토리 생성
  > - ![Screenshot from 2023-05-26 10-15-51](https://github.com/ajhwan/OpenCV_study/assets/129160008/e88e0ed0-87b4-46f1-b6b0-c4d414a60258)
> 2. catkin_make
  > - catkin_ws안에서 실행하여 'build'와 'devel' 생성
  > - ![Screenshot from 2023-05-26 10-16-01](https://github.com/ajhwan/OpenCV_study/assets/129160008/ae02ebb2-53bc-4070-949c-c149add9ca27)
> 3. gedit .bashrc
  > - ![Screenshot from 2023-05-26 10-33-28](https://github.com/ajhwan/OpenCV_study/assets/129160008/a759d8b0-521f-4524-8929-af864b091d5b) 
  > - 'cd ~'로 이동하여 실행이후 맨 아래줄에 밑에 있는 것들을 적어줌
  > - source ~/catkin_ws/devel/setup.bash
  > - alias cw='cd ~/catkin_ws'
  > - alias cs='cd ~/catkin_ws/src'
  > - alias cm='cd ~/catkin_ws && catkin_make'
  > - alias eb='gedit ~/.bashrc'
  > - alias sb='source ~/.bashrc'
  > - ![Screenshot from 2023-05-26 10-35-24](https://github.com/ajhwan/OpenCV_study/assets/129160008/bc869a4d-ee88-4856-8720-35b10aaffe6e)
> 4. catkin_create_pkg my_cam sensor_msgs cv_bridge rospy
  > - catkin_ws/src로 이동하여 작성
  > - ![Screenshot from 2023-05-26 10-49-05](https://github.com/ajhwan/OpenCV_study/assets/129160008/1a951126-cc6b-42fb-822d-287c05254c5b)

-----------------------------------------------------------------------------------------------------------------

## 카메라 통신
> 1. catkin_create_pkg my_cam sensor_msgs cv_bridge rospy 로 패키지 생성
> * rosmsg show sensor_msgs/ (tap, tap) 으로 내부 정보 확인
> * rosmsg show sensor_msgs/Image 로 이미지 메세지 정보 확인
> * bridge가 ros 와 opencv의 연결 역할을 해준다.
> 2. scripts 폴더을 생성하고, my_cam_pub.py 파일 생성

```python
#!/usr/bin/python
# -*- coding: utf-8 -*-

import cv2
import rospy
from sensor_msgs.msg import Image
from cv_bridge import CvBridge, CvBridgeError

rospy.init_node("my_cam_pub") # 노드를 지정
cap = cv2.VideoCapture(0) # 비디오 객체 만들어서 캠이랑 연결

if cap.isOpened():
    pub = rospy.Publisher("my_image", Image, queue_size=10) # 객체가 잘 연결되었을 때 퍼블리셔 생성
    bridge = CvBridge() # cv_bridge로 ros와 opencv의 데이터 변환에 사용

    fps = cap.get(cv2.CAP_PROP_FPS)
    loop_rate = rospy.Rate(fps) # FPS(초당 프레임 수)를 가져와서 특정 주기를 만들어줌

    while not rospy.is_shutdown(): 
        ret, frame = cap.read()
        if not ret:
            continue
        try:
            msg = bridge.cv2_to_imgmsg(frame, "bgr8") # frame을 img로 변환을 시켜준다. bgr8의 인코딩 사용
            pub.publish(msg)
        except CvBridgeError as e: # 에러가 발생하면 에러 출력
            print(e) # 변환 에러에대한 출력
        loop_rate.sleep()
```

> 3. my_cam_sub.py를 생성

```python
#!/usr/bin/python
#!-*- coding: utf-8 -*-

import rospy
import cv2
from sensor_msgs.msg import Image
from cv_bridge import CvBridge, CvBridgeError

bridge = CvBridge()

def imgCallback(msg):
    try:
        frame = bridge.imgmsg_to_cv2(msg, "bgr8")
    except CvBridgeError as e:
        print(e)
    
    cv2.imshow("my_image", frame)
    cv2.waitKey(3)

rospy.init_node("my_cam_sub")
sub = rospy.Subscriber("my_image", Image, imgCallback, queue_size=10)
rospy.spin()
cv2.destroyAllWindows()
```

> 4. CMakeLists.txt의 Install 부분의 catkin_install_python을 추가
> 5. cm으로 빌드 이후, roscore, rosrun my_cam my_cam_pub.py, rosrun my_cam my_cam_pub.py를 실행
----------------------------------------------------------------------------------------------------------------
## 동일 네트워크 연결

> 1. ifconfig 명령을 입력 (안될경우 : sudo apt install net-tools)
> 2. inet의 정보를 확인 : 127.0.0.1 은 나의 주소, 192.168.0.숫자 는 나의 다른 주소
> 3. eb로 bashrc접속 맨아래에 추가해주기.
```
export ROS_MASTER_URI=http://localhost:11311
export ROS_HOSTNAME=localhost

export ROS_MASTER_URI=http://192.168.0.44:11311
export ROS_HOSTNAME=192.168.0.64(내 inet를 입력)
```
> * 띄어쓰기는 '_'로 입력
> 6. rostopic echo /hello
> 7. rostopic pub /hello std_msgs/String 'dtat: hello'로 마스터에서 접속 host 로 전송된다.

#### 마스터에게 이미지 전송
> 1. 구별을 위해서 노드의 토픽의 이름을 수정한다.
>   * com64/my_image와 같이 namespace를 사용한다. 구분의 유용성을 높여준다.
> 2. 노드의 이름도 수정을 한다. rospy.init_node('my_cam_pub', anonymous=True) 노드이름뒤에 랜덤한 숫자생성
> 3. 마스터는 rosnode list로 연결을 확인을 할 수 있다.



